#cloud-config
hostname: ${server_name}
package_update: true
package_upgrade: true
package_reboot_if_required: true
ssh_pwauth: false
disable_root: true

# Install Nginx and Certbot
packages: 
  - nginx
  - certbot
  - python3-certbot-nginx
  - ufw
  - fail2ban
  - plocate

users:
  - default
  - name: ${devops_username}
    groups: [sudo]
    sudo: "ALL=(ALL) NOPASSWD:ALL"
    lock_passwd: true
    ssh_authorized_keys:
%{~ for key in ssh_public_keys ~}
      - ${key}
%{~ endfor ~}

write_files:
  - path: /etc/ssh/sshd_config.d/99-hardening.conf
    content: |
      PasswordAuthentication no
      PermitRootLogin no
  - path: /etc/fail2ban/jail.local
    content: |
      [DEFAULT]
      banaction = ufw
      backend = systemd
      maxretry = 5
      findtime = 10m
      bantime = 10m
      ignoreip = 127.0.0.1/8 ::1
      [sshd]
      enabled = true

runcmd:
  # Basic system update
  - [bash, -lc, "export DEBIAN_FRONTEND=noninteractive; apt-get update && apt-get dist-upgrade -y"]
  
  # Restart SSH to apply config
  - [systemctl, restart, ssh]

  # Firewall Setup (Allow SSH, HTTP, HTTPS)
  - [bash, -lc, "ufw default deny incoming; ufw default allow outgoing; ufw allow 22/tcp; ufw allow 80/tcp; ufw allow 443/tcp; ufw --force enable"]
  
  # Enable Services
  - [systemctl, enable, --now, nginx]
  - [systemctl, enable, --now, fail2ban]
  - [bash, -lc, "systemctl enable --now plocate-updatedb.timer; plocate-updatedb"]

  # Echo instructions to the log
  - echo "System ready. Run certbot interactively or via script to configure TLS."
