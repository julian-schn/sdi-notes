#cloud-config
# Exercise 27 - Cloud-init with Nginx SSL configuration

hostname: ${server_name}

users:
  - name: ${devops_username}
    groups: sudo
    shell: /bin/bash
    sudo: ['ALL=(ALL) NOPASSWD:ALL']
    ssh_authorized_keys:
%{ for key in ssh_public_keys ~}
      - ${key}
%{ endfor ~}

package_update: true
package_upgrade: true

packages:
  - vim
  - curl
  - wget
  - nginx

write_files:
  - path: /etc/nginx/ssl/certificate.pem
    encoding: b64
    content: ${certificate_content}
    permissions: '0644'
    owner: root:root

  - path: /etc/nginx/ssl/private.pem
    encoding: b64
    content: ${private_key_content}
    permissions: '0600'
    owner: root:root

  - path: /etc/nginx/sites-available/default
    content: |
      server {
          listen 80 default_server;
          listen [::]:80 default_server;
          server_name _;
          return 301 https://$host$request_uri;
      }

      server {
          listen 443 ssl default_server;
          listen [::]:443 ssl default_server;
          
          server_name ${dns_zone} *.${dns_zone};

          ssl_certificate /etc/nginx/ssl/certificate.pem;
          ssl_certificate_key /etc/nginx/ssl/private.pem;
          
          ssl_protocols TLSv1.2 TLSv1.3;
          ssl_ciphers HIGH:!aNULL:!MD5;
          ssl_prefer_server_ciphers on;

          root /var/www/html;
          index index.html;

          location / {
              try_files $uri $uri/ =404;
          }
      }
    permissions: '0644'

  - path: /var/www/html/index.html
    content: |
      <!DOCTYPE html>
      <html>
      <head>
          <title>Exercise 27 - Combined SSL</title>
          <style>
              body { font-family: Arial, sans-serif; margin: 50px; background: #0f172a; color: #e2e8f0; }
              .success { color: #22c55e; font-size: 1.5em; }
              h1 { color: #3b82f6; }
              .info { background: #1e293b; padding: 20px; border-radius: 8px; margin: 20px 0; }
          </style>
      </head>
      <body>
          <h1>üîê Exercise 27 - Combined Certificate & Server</h1>
          <p class="success">‚úÖ Certificate generated and server created in one terraform apply!</p>
          <div class="info">
              <p><strong>Domain:</strong> ${dns_zone}</p>
              <p><strong>Wildcard:</strong> *.${dns_zone}</p>
              <p>Provisioned by Terraform - Exercise 27</p>
          </div>
      </body>
      </html>
    permissions: '0644'

runcmd:
  - mkdir -p /etc/nginx/ssl
  - nginx -t
  - systemctl enable nginx
  - systemctl restart nginx

final_message: "Exercise 27 complete - SSL server ready"
