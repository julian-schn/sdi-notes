#cloud-config
# Exercise 28 - Internal Server Cloud-Init Configuration

hostname: ${hostname}
fqdn: ${hostname}.${dns_domain_name}
manage_etc_hosts: template

# Disable password authentication and root login
ssh_pwauth: false
disable_root: true

# Package management - NOTE: Updates will fail without Internet access
# This will be resolved in Exercise 29 with apt-cacher-ng
package_update: false
package_upgrade: false
package_reboot_if_required: false

packages:
  - ufw
  - plocate
  - netcat-openbsd
  - net-tools

# User configuration
users:
  - default
  - name: ${devops_username}
    groups: [sudo]
    sudo: "ALL=(ALL) NOPASSWD:ALL"
    lock_passwd: true
    ssh_authorized_keys:
%{ for key in ssh_authorized_keys ~}
      - ${key}
%{~ endfor ~}

# Write configuration files
write_files:
  # SSH hardening configuration
  - path: /etc/ssh/sshd_config.d/99-hardening.conf
    content: |
      PasswordAuthentication no
      PermitRootLogin no
      PubkeyAuthentication yes

  # Custom hosts template for DNS resolution
  - path: /etc/cloud/templates/hosts.debian.tmpl
    content: |
      ## template:jinja
      {#
      This file /etc/cloud/templates/hosts.debian.tmpl is only utilized
      if enabled in cloud-config.  Specifically, in order to enable it
      you need to add the following to config:
        manage_etc_hosts: template
      -#}
      127.0.1.1 {{fqdn}} {{hostname}}
      127.0.0.1 localhost

      ${gateway_private_ip} gateway.${dns_domain_name} gateway
      ${intern_private_ip} intern.${dns_domain_name} intern

      # The following lines are desirable for IPv6 capable hosts
      ::1 localhost ip6-localhost ip6-loopback
      ff02::1 ip6-allnodes
      ff02::2 ip6-allrouters

  # Informational file about Internet access
  - path: /etc/motd
    content: |
      ================================================================================
      This is an internal server with NO INTERNET ACCESS
      ================================================================================

      This server is connected to a private subnet only.
      - Package updates/installs are NOT currently available
      - Internet connectivity tests will fail
      - Access is available via gateway host only

      To add Internet access for package management, see Exercise 29.
      ================================================================================

# Commands to run after boot
runcmd:
  # Restart SSH service with new configuration
  - [systemctl, restart, ssh]

  # Configure UFW firewall (allow from private network)
  - [bash, -lc, "ufw default deny incoming"]
  - [bash, -lc, "ufw default allow outgoing"]
  - [bash, -lc, "ufw allow from 10.0.1.0/24"]
  - [bash, -lc, "ufw --force enable"]

  # Enable plocate (won't update but will be ready)
  - [bash, -lc, "systemctl enable plocate-updatedb.timer"]

# Final message
final_message: "Internal server is ready after $UPTIME seconds (NO INTERNET ACCESS)"
